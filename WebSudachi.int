
import sys
import os
import socket
import subprocess
import time
import webbrowser
import threading

# çŸ«æ­£å½“å‰è¿è¡Œç›®å½•
os.chdir(os.path.dirname(__file__))

# è®¾ç½® sys.path
sys.path.insert(0, os.path.abspath('site-packages'))
sys.path.insert(0, os.path.abspath('.'))


def is_port_in_use(port=8000):
    """æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨"""
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        return s.connect_ex(('127.0.0.1', port)) == 0


def kill_process_on_port(port=8000):
    """æ€æ‰å ç”¨æŒ‡å®šç«¯å£çš„è¿›ç¨‹ (Windows)"""
    try:
        result = subprocess.run(
            f'netstat -ano | findstr :{port}',
            shell=True,
            capture_output=True,
            text=True
        )

        if result.stdout:
            lines = result.stdout.strip().split('\n')
            for line in lines:
                if 'LISTENING' in line:
                    pid = line.strip().split()[-1]
                    print(f"  âš ï¸  å‘ç°ç«¯å£ {port} è¢«è¿›ç¨‹ PID {pid} å ç”¨")
                    print(f"  ğŸ”§ æ­£åœ¨æ¸…ç†...")
                    subprocess.run(f'taskkill /PID {pid} /F', shell=True, capture_output=True)
                    time.sleep(1)
                    print(f"  âœ… ç«¯å£ {port} å·²æ¸…ç†\n")
                    return True
        return False
    except Exception as e:
        print(f"  âœ— æ¸…ç†ç«¯å£å¤±è´¥: {e}")
        return False


def check_health(port=8000, max_retries=15):
    """æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€å¹¶æ‰“å¼€æµè§ˆå™¨"""
    import urllib.request
    import json

    print("  â³ æ­£åœ¨ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨...")

    for i in range(max_retries):
        try:
            url = f"http://127.0.0.1:{port}/health"
            with urllib.request.urlopen(url, timeout=2) as response:
                data = json.loads(response.read().decode())

                # æ¸…å±ï¼ˆå¯é€‰ï¼‰
                # os.system('cls' if os.name == 'nt' else 'clear')

                print("\n" + "="*70)
                print("  ğŸŒ¸ WebSudachi - æ—¥æœ¬èªå½¢æ…‹ç´ è§£æãƒ„ãƒ¼ãƒ«")
                print("="*70)
                print(f"\n  âœ… æœåŠ¡å™¨çŠ¶æ€: {data.get('status', 'unknown').upper()}")
                print(f"  ğŸ“ è®¿é—®åœ°å€: http://127.0.0.1:{port}")
                print(f"  ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯: {data.get('version', 'unknown')}")

                # Sudachi çŠ¶æ€
                if data.get('sudachi_available'):
                    print(f"  ğŸŒ¸ Sudachi å¼•æ“: âœ… å·²åŠ è½½")
                else:
                    print(f"  ğŸŒ¸ Sudachi å¼•æ“: âš ï¸  ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®")

                print("\n" + "-"*70)
                print("  ğŸ’¡ ä½¿ç”¨æç¤º:")
                print("     â€¢ æµè§ˆå™¨å°†åœ¨ 2 ç§’åè‡ªåŠ¨æ‰“å¼€")
                print("     â€¢ æŒ‰ Ctrl+C å¯ä»¥åœæ­¢æœåŠ¡å™¨")
                print("     â€¢ æŠ¥å‘Šé—®é¢˜: https://github.com/NoHeartPen/WebSudachi/issues")
                print("-"*70 + "\n")

                return True

        except Exception as e:
            if i < max_retries - 1:
                time.sleep(0.5)
            else:
                print(f"\n  âœ— æœåŠ¡å™¨å¯åŠ¨è¶…æ—¶: {e}")
                return False

    return False


def start_server():
    """å¯åŠ¨æœåŠ¡å™¨"""
    PORT = 8000

    # æ‰“å°å¯åŠ¨ä¿¡æ¯
    print("\n" + "="*70)
    print("  ğŸš€ WebSudachi å¯åŠ¨ä¸­...")
    print("="*70 + "\n")

    # æ£€æŸ¥ç«¯å£å ç”¨
    if is_port_in_use(PORT):
        print(f"  âš ï¸  ç«¯å£ {PORT} å·²è¢«å ç”¨\n")
        if not kill_process_on_port(PORT):
            print(f"\n  âœ— æ— æ³•è‡ªåŠ¨æ¸…ç†ç«¯å£ {PORT}")
            print(f"\n  ğŸ“ è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¸…ç†:")
            print(f"     netstat -ano | findstr :{PORT}")
            print(f"     taskkill /PID <è¿›ç¨‹ID> /F\n")
            input("  æŒ‰å›è½¦é”®é€€å‡º...")
            sys.exit(1)
        time.sleep(1)

    # åœ¨åå°çº¿ç¨‹æ£€æŸ¥å¥åº·çŠ¶æ€å¹¶æ‰“å¼€æµè§ˆå™¨
    def health_check_and_open_browser():
        if check_health(PORT):
            time.sleep(2)
            print("  ğŸŒ æ­£åœ¨æ‰“å¼€æµè§ˆå™¨...\n")
            webbrowser.open(f"http://127.0.0.1:{PORT}")

    threading.Thread(target=health_check_and_open_browser, daemon=True).start()

    # å¯¼å…¥å¹¶å¯åŠ¨ FastAPI åº”ç”¨
    try:
        import uvicorn
        from app import app

        # å¯åŠ¨æœåŠ¡å™¨ï¼ˆè¿™ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼‰
        uvicorn.run(
            app,
            host="127.0.0.1",
            port=PORT,
            log_level="info"
        )

    except ImportError as e:
        print(f"\n  âœ— å¯¼å…¥æ¨¡å—å¤±è´¥: {e}")
        print(f"\n  ğŸ“ è¯·æ£€æŸ¥ï¼š")
        print(f"     1. app.py æ˜¯å¦åœ¨æ ¹ç›®å½•")
        print(f"     2. site-packages æ˜¯å¦åŒ…å«æ‰€æœ‰ä¾èµ–\n")
        input("  æŒ‰å›è½¦é”®é€€å‡º...")
        sys.exit(1)

    except Exception as e:
        print(f"\n  âœ— å¯åŠ¨å¤±è´¥: {e}\n")
        import traceback
        traceback.print_exc()
        input("\n  æŒ‰å›è½¦é”®é€€å‡º...")
        sys.exit(1)


if __name__ == "__main__":
    try:
        start_server()

    except KeyboardInterrupt:
        print("\n\n" + "="*70)
        print("  âœ… æœåŠ¡å™¨å·²åœæ­¢")
        print("  ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ WebSudachiï¼")
        print("="*70 + "\n")
        sys.exit(0)

    except Exception as e:
        print(f"\n  âœ— æ„å¤–é”™è¯¯: {e}\n")
        import traceback
        traceback.print_exc()
        input("\n  æŒ‰å›è½¦é”®é€€å‡º...")
        sys.exit(1)